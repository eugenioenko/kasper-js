(()=>{"use strict";class t{constructor(t,e,s){this.value=t,this.line=e,this.col=s}toString(){return this.value.toString()}}class e{constructor(){}}class s extends e{constructor(t,e,s){super(),this.name=t,this.value=e,this.line=s}accept(t){return t.visitAssignExpr(this)}toString(){return"Expr.Assign"}}class r extends e{constructor(t,e,s,r){super(),this.left=t,this.operator=e,this.right=s,this.line=r}accept(t){return t.visitBinaryExpr(this)}toString(){return"Expr.Binary"}}class i extends e{constructor(t,e,s,r){super(),this.callee=t,this.paren=e,this.args=s,this.line=r}accept(t){return t.visitCallExpr(this)}toString(){return"Expr.Call"}}class n extends e{constructor(t,e){super(),this.value=t,this.line=e}accept(t){return t.visitDebugExpr(this)}toString(){return"Expr.Debug"}}class a extends e{constructor(t,e){super(),this.properties=t,this.line=e}accept(t){return t.visitDictionaryExpr(this)}toString(){return"Expr.Dictionary"}}class h extends e{constructor(t,e,s,r){super(),this.name=t,this.key=e,this.iterable=s,this.line=r}accept(t){return t.visitEachExpr(this)}toString(){return"Expr.Each"}}class o extends e{constructor(t,e,s,r){super(),this.entity=t,this.key=e,this.type=s,this.line=r}accept(t){return t.visitGetExpr(this)}toString(){return"Expr.Get"}}class c extends e{constructor(t,e){super(),this.expression=t,this.line=e}accept(t){return t.visitGroupingExpr(this)}toString(){return"Expr.Grouping"}}class u extends e{constructor(t,e){super(),this.name=t,this.line=e}accept(t){return t.visitKeyExpr(this)}toString(){return"Expr.Key"}}class l extends e{constructor(t,e,s,r){super(),this.left=t,this.operator=e,this.right=s,this.line=r}accept(t){return t.visitLogicalExpr(this)}toString(){return"Expr.Logical"}}class p extends e{constructor(t,e){super(),this.value=t,this.line=e}accept(t){return t.visitListExpr(this)}toString(){return"Expr.List"}}class d extends e{constructor(t,e){super(),this.value=t,this.line=e}accept(t){return t.visitLiteralExpr(this)}toString(){return"Expr.Literal"}}class m extends e{constructor(t,e){super(),this.clazz=t,this.line=e}accept(t){return t.visitNewExpr(this)}toString(){return"Expr.New"}}class f extends e{constructor(t,e,s){super(),this.left=t,this.right=e,this.line=s}accept(t){return t.visitNullCoalescingExpr(this)}toString(){return"Expr.NullCoalescing"}}class v extends e{constructor(t,e,s){super(),this.name=t,this.increment=e,this.line=s}accept(t){return t.visitPostfixExpr(this)}toString(){return"Expr.Postfix"}}class g extends e{constructor(t,e,s,r){super(),this.entity=t,this.key=e,this.value=s,this.line=r}accept(t){return t.visitSetExpr(this)}toString(){return"Expr.Set"}}class E extends e{constructor(t,e){super(),this.value=t,this.line=e}accept(t){return t.visitTemplateExpr(this)}toString(){return"Expr.Template"}}class x extends e{constructor(t,e,s,r){super(),this.condition=t,this.thenExpr=e,this.elseExpr=s,this.line=r}accept(t){return t.visitTernaryExpr(this)}toString(){return"Expr.Ternary"}}class k extends e{constructor(t,e){super(),this.value=t,this.line=e}accept(t){return t.visitTypeofExpr(this)}toString(){return"Expr.Typeof"}}class w extends e{constructor(t,e,s){super(),this.operator=t,this.right=e,this.line=s}accept(t){return t.visitUnaryExpr(this)}toString(){return"Expr.Unary"}}class y extends e{constructor(t,e){super(),this.name=t,this.line=e}accept(t){return t.visitVariableExpr(this)}toString(){return"Expr.Variable"}}class b extends e{constructor(t,e){super(),this.value=t,this.line=e}accept(t){return t.visitVoidExpr(this)}toString(){return"Expr.Void"}}var S;!function(t){t[t.Eof=0]="Eof",t[t.Panic=1]="Panic",t[t.Ampersand=2]="Ampersand",t[t.AtSign=3]="AtSign",t[t.Caret=4]="Caret",t[t.Comma=5]="Comma",t[t.Dollar=6]="Dollar",t[t.Dot=7]="Dot",t[t.Hash=8]="Hash",t[t.LeftBrace=9]="LeftBrace",t[t.LeftBracket=10]="LeftBracket",t[t.LeftParen=11]="LeftParen",t[t.Percent=12]="Percent",t[t.Pipe=13]="Pipe",t[t.RightBrace=14]="RightBrace",t[t.RightBracket=15]="RightBracket",t[t.RightParen=16]="RightParen",t[t.Semicolon=17]="Semicolon",t[t.Slash=18]="Slash",t[t.Star=19]="Star",t[t.Arrow=20]="Arrow",t[t.Bang=21]="Bang",t[t.BangEqual=22]="BangEqual",t[t.Colon=23]="Colon",t[t.Equal=24]="Equal",t[t.EqualEqual=25]="EqualEqual",t[t.Greater=26]="Greater",t[t.GreaterEqual=27]="GreaterEqual",t[t.Less=28]="Less",t[t.LessEqual=29]="LessEqual",t[t.Minus=30]="Minus",t[t.MinusEqual=31]="MinusEqual",t[t.MinusMinus=32]="MinusMinus",t[t.PercentEqual=33]="PercentEqual",t[t.Plus=34]="Plus",t[t.PlusEqual=35]="PlusEqual",t[t.PlusPlus=36]="PlusPlus",t[t.Question=37]="Question",t[t.QuestionDot=38]="QuestionDot",t[t.QuestionQuestion=39]="QuestionQuestion",t[t.SlashEqual=40]="SlashEqual",t[t.StarEqual=41]="StarEqual",t[t.DotDot=42]="DotDot",t[t.DotDotDot=43]="DotDotDot",t[t.LessEqualGreater=44]="LessEqualGreater",t[t.Identifier=45]="Identifier",t[t.Template=46]="Template",t[t.String=47]="String",t[t.Number=48]="Number",t[t.And=49]="And",t[t.Const=50]="Const",t[t.Debug=51]="Debug",t[t.False=52]="False",t[t.Instanceof=53]="Instanceof",t[t.New=54]="New",t[t.Null=55]="Null",t[t.Undefined=56]="Undefined",t[t.Of=57]="Of",t[t.Or=58]="Or",t[t.True=59]="True",t[t.Typeof=60]="Typeof",t[t.Void=61]="Void",t[t.With=62]="With"}(S||(S={}));class T{constructor(t,e,s,r,i){this.name=S[t],this.type=t,this.lexeme=e,this.literal=s,this.line=r,this.col=i}toString(){return`[(${this.line}):"${this.lexeme}"]`}}const q=[" ","\n","\t","\r"],$=["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"];class P{constructor(){this.errorLevel=1}parse(e){this.current=0,this.tokens=e,this.errors=[];const s=[];for(;!this.eof();)try{s.push(this.expression())}catch(e){if(e instanceof t)this.errors.push(`Parse Error (${e.line}:${e.col}) => ${e.value}`);else if(this.errors.push(`${e}`),this.errors.length>100)return this.errors.push("Parse Error limit exceeded"),s;this.synchronize()}return s}match(...t){for(const e of t)if(this.check(e))return this.advance(),!0;return!1}advance(){return this.eof()||this.current++,this.previous()}peek(){return this.tokens[this.current]}previous(){return this.tokens[this.current-1]}check(t){return this.peek().type===t}eof(){return this.check(S.Eof)}consume(t,e){return this.check(t)?this.advance():this.error(this.peek(),e+`, unexpected token "${this.peek().lexeme}"`)}error(e,s){throw new t(s,e.line,e.col)}synchronize(){do{if(this.check(S.Semicolon)||this.check(S.RightBrace))return void this.advance();this.advance()}while(!this.eof())}foreach(t){this.current=0,this.tokens=t,this.errors=[];const e=this.consume(S.Identifier,'Expected an identifier inside "each" statement');let s=null;this.match(S.With)&&(s=this.consume(S.Identifier,'Expected a "key" identifier after "with" keyword in foreach statement')),this.consume(S.Of,'Expected "of" keyword inside foreach statement');const r=this.expression();return new h(e,s,r,e.line)}expression(){const t=this.assignment();if(this.match(S.Semicolon))for(;this.match(S.Semicolon););return t}assignment(){const t=this.ternary();if(this.match(S.Equal,S.PlusEqual,S.MinusEqual,S.StarEqual,S.SlashEqual)){const e=this.previous();let i=this.assignment();if(t instanceof y){const n=t.name;return e.type!==S.Equal&&(i=new r(new y(n,n.line),e,i,e.line)),new s(n,i,n.line)}if(t instanceof o)return e.type!==S.Equal&&(i=new r(new o(t.entity,t.key,t.type,t.line),e,i,e.line)),new g(t.entity,t.key,i,t.line);this.error(e,"Invalid l-value, is not an assigning target.")}return t}ternary(){const t=this.nullCoalescing();if(this.match(S.Question)){const e=this.ternary();this.consume(S.Colon,'Expected ":" after ternary ? expression');const s=this.ternary();return new x(t,e,s,t.line)}return t}nullCoalescing(){const t=this.logicalOr();if(this.match(S.QuestionQuestion)){const e=this.nullCoalescing();return new f(t,e,t.line)}return t}logicalOr(){let t=this.logicalAnd();for(;this.match(S.Or);){const e=this.previous(),s=this.logicalAnd();t=new l(t,e,s,e.line)}return t}logicalAnd(){let t=this.equality();for(;this.match(S.And);){const e=this.previous(),s=this.equality();t=new l(t,e,s,e.line)}return t}equality(){let t=this.addition();for(;this.match(S.BangEqual,S.EqualEqual,S.Greater,S.GreaterEqual,S.Less,S.LessEqual);){const e=this.previous(),s=this.addition();t=new r(t,e,s,e.line)}return t}addition(){let t=this.modulus();for(;this.match(S.Minus,S.Plus);){const e=this.previous(),s=this.modulus();t=new r(t,e,s,e.line)}return t}modulus(){let t=this.multiplication();for(;this.match(S.Percent);){const e=this.previous(),s=this.multiplication();t=new r(t,e,s,e.line)}return t}multiplication(){let t=this.typeof();for(;this.match(S.Slash,S.Star);){const e=this.previous(),s=this.typeof();t=new r(t,e,s,e.line)}return t}typeof(){if(this.match(S.Typeof)){const t=this.previous(),e=this.typeof();return new k(e,t.line)}return this.unary()}unary(){if(this.match(S.Minus,S.Bang,S.Dollar,S.PlusPlus,S.MinusMinus)){const t=this.previous(),e=this.unary();return new w(t,e,t.line)}return this.newKeyword()}newKeyword(){if(this.match(S.New)){const t=this.previous(),e=this.call();return new m(e,t.line)}return this.call()}call(){let t=this.primary(),e=!0;do{if(e=!1,this.match(S.LeftParen)){e=!0;do{const e=[];if(!this.check(S.RightParen))do{e.push(this.expression())}while(this.match(S.Comma));const s=this.consume(S.RightParen,'Expected ")" after arguments');t=new i(t,s,e,s.line)}while(this.match(S.LeftParen))}this.match(S.Dot,S.QuestionDot)&&(e=!0,t=this.dotGet(t,this.previous())),this.match(S.LeftBracket)&&(e=!0,t=this.bracketGet(t,this.previous()))}while(e);return t}dotGet(t,e){const s=this.consume(S.Identifier,"Expect property name after '.'"),r=new u(s,s.line);return new o(t,r,e.type,s.line)}bracketGet(t,e){let s=null;return this.check(S.RightBracket)||(s=this.expression()),this.consume(S.RightBracket,'Expected "]" after an index'),new o(t,s,e.type,e.line)}primary(){if(this.match(S.False))return new d(!1,this.previous().line);if(this.match(S.True))return new d(!0,this.previous().line);if(this.match(S.Null))return new d(null,this.previous().line);if(this.match(S.Undefined))return new d(void 0,this.previous().line);if(this.match(S.Number)||this.match(S.String))return new d(this.previous().literal,this.previous().line);if(this.match(S.Template))return new E(this.previous().literal,this.previous().line);if(this.match(S.Identifier)){const t=this.previous();return this.match(S.PlusPlus)?new v(t,1,t.line):this.match(S.MinusMinus)?new v(t,-1,t.line):new y(t,t.line)}if(this.match(S.LeftParen)){const t=this.expression();return this.consume(S.RightParen,'Expected ")" after expression'),new c(t,t.line)}if(this.match(S.LeftBrace))return this.dictionary();if(this.match(S.LeftBracket))return this.list();if(this.match(S.Void)){const t=this.expression();return new b(t,this.previous().line)}if(this.match(S.Debug)){const t=this.expression();return new n(t,this.previous().line)}throw this.error(this.peek(),`Expected expression, unexpected token "${this.peek().lexeme}"`)}dictionary(){const t=this.previous();if(this.match(S.RightBrace))return new a([],this.previous().line);const e=[];do{if(this.match(S.String,S.Identifier,S.Number)){const t=this.previous();if(this.match(S.Colon)){const s=this.expression();e.push(new g(null,new u(t,t.line),s,t.line))}else{const s=new y(t,t.line);e.push(new g(null,new u(t,t.line),s,t.line))}}else this.error(this.peek(),`String, Number or Identifier expected as a Key of Dictionary {, unexpected token ${this.peek().lexeme}`)}while(this.match(S.Comma));return this.consume(S.RightBrace,'Expected "}" after object literal'),new a(e,t.line)}list(){const t=[],e=this.previous();if(this.match(S.RightBracket))return new p([],this.previous().line);do{t.push(this.expression())}while(this.match(S.Comma));return this.consume(S.RightBracket,'Expected "]" after array declaration'),new p(t,e.line)}}function N(t){return t>="0"&&t<="9"}function C(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"||"$"===t}class L{scan(t){for(this.source=t,this.tokens=[],this.errors=[],this.current=0,this.start=0,this.line=1,this.col=1;!this.eof();){this.start=this.current;try{this.getToken()}catch(t){if(this.errors.push(`${t}`),this.errors.length>100)return this.errors.push("Error limit exceeded"),this.tokens}}return this.tokens.push(new T(S.Eof,"",null,this.line,0)),this.tokens}eof(){return this.current>=this.source.length}advance(){return"\n"===this.peek()&&(this.line++,this.col=0),this.current++,this.col++,this.source.charAt(this.current-1)}addToken(t,e){const s=this.source.substring(this.start,this.current);this.tokens.push(new T(t,s,e,this.line,this.col))}match(t){return!this.eof()&&this.source.charAt(this.current)===t&&(this.current++,!0)}peek(){return this.eof()?"\0":this.source.charAt(this.current)}peekNext(){return this.current+1>=this.source.length?"\0":this.source.charAt(this.current+1)}comment(){for(;"\n"!==this.peek()&&!this.eof();)this.advance()}multilineComment(){for(;!this.eof()&&("*"!==this.peek()||"/"!==this.peekNext());)this.advance();this.eof()?this.error('Unterminated comment, expecting closing "*/"'):(this.advance(),this.advance())}string(t){for(;this.peek()!==t&&!this.eof();)this.advance();if(this.eof())return void this.error(`Unterminated string, expecting closing ${t}`);this.advance();const e=this.source.substring(this.start+1,this.current-1);this.addToken("`"!==t?S.String:S.Template,e)}number(){for(;N(this.peek());)this.advance();for("."===this.peek()&&N(this.peekNext())&&this.advance();N(this.peek());)this.advance();for("e"===this.peek().toLowerCase()&&(this.advance(),"-"!==this.peek()&&"+"!==this.peek()||this.advance());N(this.peek());)this.advance();const t=this.source.substring(this.start,this.current);this.addToken(S.Number,Number(t))}identifier(){for(;C(t=this.peek())||N(t);)this.advance();var t;const e=this.source.substring(this.start,this.current),s=(r=e).charAt(0).toUpperCase()+r.substring(1).toLowerCase();var r;!function(t){return S[t]>=S.And}(s)?this.addToken(S.Identifier,e):this.addToken(S[s],e)}getToken(){const t=this.advance();switch(t){case"(":this.addToken(S.LeftParen,null);break;case")":this.addToken(S.RightParen,null);break;case"[":this.addToken(S.LeftBracket,null);break;case"]":this.addToken(S.RightBracket,null);break;case"{":this.addToken(S.LeftBrace,null);break;case"}":this.addToken(S.RightBrace,null);break;case",":this.addToken(S.Comma,null);break;case";":this.addToken(S.Semicolon,null);break;case"^":this.addToken(S.Caret,null);break;case"#":this.addToken(S.Hash,null);break;case":":this.addToken(this.match("=")?S.Arrow:S.Colon,null);break;case"*":this.addToken(this.match("=")?S.StarEqual:S.Star,null);break;case"%":this.addToken(this.match("=")?S.PercentEqual:S.Percent,null);break;case"|":this.addToken(this.match("|")?S.Or:S.Pipe,null);break;case"&":this.addToken(this.match("&")?S.And:S.Ampersand,null);break;case">":this.addToken(this.match("=")?S.GreaterEqual:S.Greater,null);break;case"!":this.addToken(this.match("=")?S.BangEqual:S.Bang,null);break;case"?":this.addToken(this.match("?")?S.QuestionQuestion:this.match(".")?S.QuestionDot:S.Question,null);break;case"=":if(this.match("=")){this.addToken((this.match("="),S.EqualEqual),null);break}this.addToken(this.match(">")?S.Arrow:S.Equal,null);break;case"+":this.addToken(this.match("+")?S.PlusPlus:this.match("=")?S.PlusEqual:S.Plus,null);break;case"-":this.addToken(this.match("-")?S.MinusMinus:this.match("=")?S.MinusEqual:S.Minus,null);break;case"<":this.addToken(this.match("=")?this.match(">")?S.LessEqualGreater:S.LessEqual:S.Less,null);break;case".":this.match(".")?this.match(".")?this.addToken(S.DotDotDot,null):this.addToken(S.DotDot,null):this.addToken(S.Dot,null);break;case"/":this.match("/")?this.comment():this.match("*")?this.multilineComment():this.addToken(this.match("=")?S.SlashEqual:S.Slash,null);break;case"'":case'"':case"`":this.string(t);break;case"\n":case" ":case"\r":case"\t":break;default:N(t)?this.number():C(t)?this.identifier():this.error(`Unexpected character '${t}'`)}}error(t){throw new Error(`Scan Error (${this.line}:${this.col}) => ${t}`)}}class A{constructor(t,e){this.parent=t||null,this.values=e||{}}init(t){this.values=t||{}}set(t,e){this.values[t]=e}get(t){return void 0!==this.values[t]?this.values[t]:null!==this.parent?this.parent.get(t):window[t]}}class D{constructor(){this.scope=new A,this.errors=[],this.scanner=new L,this.parser=new P}evaluate(t){return t.result=t.accept(this)}error(t){throw new Error(`Runtime Error => ${t}`)}visitVariableExpr(t){return this.scope.get(t.name.lexeme)}visitAssignExpr(t){const e=this.evaluate(t.value);return this.scope.set(t.name.lexeme,e),e}visitKeyExpr(t){return t.name.literal}visitGetExpr(t){const e=this.evaluate(t.entity),s=this.evaluate(t.key);if(e||t.type!==S.QuestionDot)return e[s]}visitSetExpr(t){const e=this.evaluate(t.entity),s=this.evaluate(t.key),r=this.evaluate(t.value);return e[s]=r,r}visitPostfixExpr(t){const e=this.scope.get(t.name.lexeme),s=e+t.increment;return this.scope.set(t.name.lexeme,s),e}visitListExpr(t){const e=[];for(const s of t.value){const t=this.evaluate(s);e.push(t)}return e}templateParse(t){const e=this.scanner.scan(t),s=this.parser.parse(e);this.parser.errors.length&&this.error(`Template string  error: ${this.parser.errors[0]}`);let r="";for(const t of s)r+=this.evaluate(t).toString();return r}visitTemplateExpr(t){return t.value.replace(/\{\{([\s\S]+?)\}\}/g,((t,e)=>this.templateParse(e)))}visitBinaryExpr(t){const e=this.evaluate(t.left),s=this.evaluate(t.right);switch(t.operator.type){case S.Minus:case S.MinusEqual:return e-s;case S.Slash:case S.SlashEqual:return e/s;case S.Star:case S.StarEqual:return e*s;case S.Percent:case S.PercentEqual:return e%s;case S.Plus:case S.PlusEqual:return e+s;case S.Pipe:return e|s;case S.Caret:return e^s;case S.Greater:return e>s;case S.GreaterEqual:return e>=s;case S.Less:return e<s;case S.LessEqual:return e<=s;case S.EqualEqual:return e===s;case S.BangEqual:return e!==s;default:return this.error("Unknown binary operator "+t.operator),null}}visitLogicalExpr(t){const e=this.evaluate(t.left);if(t.operator.type===S.Or){if(e)return e}else if(!e)return e;return this.evaluate(t.right)}visitTernaryExpr(t){return this.evaluate(t.condition).isTruthy()?this.evaluate(t.thenExpr):this.evaluate(t.elseExpr)}visitNullCoalescingExpr(t){return this.evaluate(t.left)||this.evaluate(t.right)}visitGroupingExpr(t){return this.evaluate(t.expression)}visitLiteralExpr(t){return t.value}visitUnaryExpr(t){const e=this.evaluate(t.right);switch(t.operator.type){case S.Minus:return-e;case S.Bang:return!e;case S.PlusPlus:case S.MinusMinus:const s=Number(e)+(t.operator.type===S.PlusPlus?1:-1);if(t.right instanceof y)this.scope.set(t.right.name.lexeme,s);else if(t.right instanceof o){const e=new g(t.right.entity,t.right.key,new d(s,t.line),t.line);this.evaluate(e)}else this.error(`Invalid right-hand side expression in prefix operation:  ${t.right}`);return s;default:return this.error("Unknown unary operator ' + expr.operator"),null}}visitCallExpr(t){const e=this.evaluate(t.callee);"function"!=typeof e&&this.error(`${e} is not a function`);const s=[];for(const e of t.args)s.push(this.evaluate(e));return t.callee instanceof o&&(t.callee.entity instanceof y||t.callee.entity instanceof c)?e.apply(t.callee.entity.result,s):e(...s)}visitNewExpr(t){const e=t.clazz,s=this.evaluate(e.callee);"function"!=typeof s&&this.error(`'${s}' is not a class. 'new' statement must be used with classes.`);const r=[];for(const t of e.args)r.push(this.evaluate(t));return new s(...r)}visitDictionaryExpr(t){const e={};for(const s of t.properties){const t=this.evaluate(s.key),r=this.evaluate(s.value);e[t]=r}return e}visitTypeofExpr(t){return typeof this.evaluate(t.value)}visitEachExpr(t){return[t.name.lexeme,t.key?t.key.lexeme:null,this.evaluate(t.iterable)]}visitVoidExpr(t){return this.evaluate(t.value),""}visitDebugExpr(t){const e=this.evaluate(t.value);return console.log(e),""}}class B{}class M extends B{constructor(t,e,s,r,i=0){super(),this.type="element",this.name=t,this.attributes=e,this.children=s,this.self=r,this.line=i}accept(t,e){return t.visitElementKNode(this,e)}toString(){return"KNode.Element"}}class K extends B{constructor(t,e,s=0){super(),this.type="attribute",this.name=t,this.value=e,this.line=s}accept(t,e){return t.visitAttributeKNode(this,e)}toString(){return"KNode.Attribute"}}class R extends B{constructor(t,e=0){super(),this.type="text",this.value=t,this.line=e}accept(t,e){return t.visitTextKNode(this,e)}toString(){return"KNode.Text"}}class G extends B{constructor(t,e=0){super(),this.type="comment",this.value=t,this.line=e}accept(t,e){return t.visitCommentKNode(this,e)}toString(){return"KNode.Comment"}}class I extends B{constructor(t,e=0){super(),this.type="doctype",this.value=t,this.line=e}accept(t,e){return t.visitDoctypeKNode(this,e)}toString(){return"KNode.Doctype"}}class Q{parse(e){for(this.current=0,this.line=1,this.col=1,this.source=e,this.errors=[],this.nodes=[];!this.eof();)try{const t=this.node();if(null===t)continue;this.nodes.push(t)}catch(e){if(e instanceof t)this.errors.push(`Parse Error (${e.line}:${e.col}) => ${e.value}`);else if(this.errors.push(`${e}`),this.errors.length>10)return this.errors.push("Parse Error limit exceeded"),this.nodes;break}return this.source="",this.nodes}match(...t){for(const e of t)if(this.check(e))return this.current+=e.length,!0;return!1}advance(t=""){this.eof()?this.error(`Unexpected end of file. ${t}`):(this.check("\n")&&(this.line+=1,this.col=0),this.col+=1,this.current++)}peek(...t){for(const e of t)if(this.check(e))return!0;return!1}check(t){return this.source.slice(this.current,this.current+t.length)===t}eof(){return this.current>this.source.length}error(e){throw new t(e,this.line,this.col)}node(){let t;return this.whitespace(),this.match("</")&&this.error("Unexpected closing tag"),t=this.match("\x3c!--")?this.comment():this.match("<!doctype")||this.match("<!DOCTYPE")?this.doctype():this.match("<")?this.element():this.text(),this.whitespace(),t}comment(){const t=this.current;do{this.advance("Expected comment closing '--\x3e'")}while(!this.match("--\x3e"));const e=this.source.slice(t,this.current-3);return new G(e,this.line)}doctype(){const t=this.current;do{this.advance("Expected closing doctype")}while(!this.match(">"));const e=this.source.slice(t,this.current-1).trim();return new I(e,this.line)}element(){const t=this.line,e=this.identifier("/",">");e||this.error("Expected a tag name");const s=this.attributes();if(this.match("/>")||$.includes(e)&&this.match(">"))return new M(e,s,[],!0,this.line);this.match(">")||this.error("Expected closing tag");let r=[];return this.whitespace(),this.peek("</")||(r=this.children(e)),this.close(e),new M(e,s,r,!1,t)}close(t){this.match("</")||this.error(`Expected </${t}>`),this.match(`${t}`)||this.error(`Expected </${t}>`),this.whitespace(),this.match(">")||this.error(`Expected </${t}>`)}children(t){const e=[];do{this.eof()&&this.error(`Expected </${t}>`);const s=this.node();null!==s&&e.push(s)}while(!this.peek("</"));return e}attributes(){const t=[];for(;!this.peek(">","/>")&&!this.eof();){this.whitespace();const e=this.line,s=this.identifier("=",">","/>");s||this.error("Blank attribute name"),this.whitespace();let r="";this.match("=")&&(this.whitespace(),r=this.match("'")?this.string("'"):this.match('"')?this.string('"'):this.identifier(">","/>")),this.whitespace(),t.push(new K(s,r,e))}return t}text(){const t=this.current,e=this.line;for(;!this.peek("<")&&!this.eof();)this.advance();const s=this.source.slice(t,this.current).trim();return s?new R(s,e):null}whitespace(){let t=0;for(;this.peek(...q)&&!this.eof();)t+=1,this.advance();return t}identifier(...t){this.whitespace();const e=this.current;for(;!this.peek(...q,...t);)this.advance(`Expected closing ${t}`);const s=this.current;return this.whitespace(),this.source.slice(e,s).trim()}string(t){const e=this.current;for(;!this.match(t);)this.advance(`Expected closing ${t}`);return this.source.slice(e,this.current-1)}}class O{constructor(t){this.scanner=new L,this.parser=new P,this.interpreter=new D,this.errors=[],this.registry={},t&&t.registry&&(this.registry=t.registry)}evaluate(t,e){t.accept(this,e)}execute(t,e){const s=this.scanner.scan(t),r=this.parser.parse(s),i=this.interpreter.scope;e&&(this.interpreter.scope=e);const n=r.map((t=>this.interpreter.evaluate(t)));return this.interpreter.scope=i,n&&n.length?n[0]:void 0}transpile(t,e,s){s.innerHTML="",this.interpreter.scope.init(e),this.errors=[];try{this.createSiblings(t,s)}catch(t){console.error(`${t}`)}return s}visitElementKNode(t,e){this.createElement(t,e)}visitTextKNode(t,e){const s=this.evaluateTemplateString(t.value),r=document.createTextNode(s);e&&e.appendChild(r)}visitAttributeKNode(t,e){const s=document.createAttribute(t.name);t.value&&(s.value=this.evaluateTemplateString(t.value)),e&&e.setAttributeNode(s)}visitCommentKNode(t,e){const s=new Comment(t.value);e&&e.appendChild(s)}findAttr(t,e){if(!t||!t.attributes||!t.attributes.length)return null;return t.attributes.find((t=>e.includes(t.name)))||null}doIf(t,e){if(this.execute(t[0][1].value))this.createElement(t[0][0],e);else for(const s of t.slice(1,t.length))if(this.findAttr(s[0],["@elseif"])){if(this.execute(s[1].value))return void this.createElement(s[0],e)}else if(this.findAttr(s[0],["@else"]))return void this.createElement(s[0],e)}doEach(t,e,s){const r=this.scanner.scan(t.value),[i,n,a]=this.interpreter.evaluate(this.parser.foreach(r)),h=this.interpreter.scope;let o=0;for(const t of a){const r={[i]:t};n&&(r[n]=o),this.interpreter.scope=new A(h,r),this.createElement(e,s),o+=1}this.interpreter.scope=h}doWhile(t,e,s){const r=this.interpreter.scope;for(this.interpreter.scope=new A(r);this.execute(t.value);)this.createElement(e,s);this.interpreter.scope=r}doLet(t,e,s){const r=this.interpreter.scope;this.interpreter.scope=new A(r);const i=this.createElement(e,s);this.interpreter.scope.set("$ref",i),this.execute(t.value),this.interpreter.scope=r}createSiblings(t,e){let s=0;for(;s<t.length;){const r=t[s++];if("element"===r.type){const i=this.findAttr(r,["@each"]);if(i){this.doEach(i,r,e);continue}const n=this.findAttr(r,["@if"]);if(n){const i=[[r,n]],a=r.name;let h=!0;for(;h&&!(s>=t.length);){const e=this.findAttr(t[s],["@else","@elseif"]);t[s].name===a&&e?(i.push([t[s],e]),s+=1):h=!1}this.doIf(i,e);continue}const a=this.findAttr(r,["@while"]);if(a){this.doWhile(a,r,e);continue}const h=this.findAttr(r,["@let"]);if(h){this.doLet(h,r,e);continue}}this.evaluate(r,e)}}createElement(t,e){const s="void"===t.name,r=!!this.registry[t.name],i=s?e:document.createElement(t.name),n=this.interpreter.scope;if(r){let e={};const s=t.attributes.filter((t=>t.name.startsWith("@:"))),r=this.createComponentArgs(s);if(this.registry[t.name]?.component){const s=i,n=this;e=new this.registry[t.name].component({args:r,ref:s,transpiler:n})}this.interpreter.scope=new A(n,e),this.createSiblings(this.registry[t.name].nodes,i)}if(!s){const e=t.attributes.filter((t=>t.name.startsWith("@on:")));for(const t of e)this.createEventListener(i,t);const s=t.attributes.filter((t=>!t.name.startsWith("@")));for(const t of s)this.evaluate(t,i)}return t.self||(this.createSiblings(t.children,i),this.interpreter.scope=n,!s&&e&&e.appendChild(i)),i}createComponentArgs(t){if(!t.length)return{};const e={};for(const s of t)e[s.name.split(":")[1]]=this.evaluateTemplateString(s.value);return e}createEventListener(t,e){const s=e.name.split(":")[1],r=new A(this.interpreter.scope);t.addEventListener(s,(t=>{r.set("$event",t),this.execute(e.value,r)}))}evaluateTemplateString(t){return t&&/\{\{.+\}\}/ms.test(t)?t.replace(/\{\{([\s\S]+?)\}\}/g,((t,e)=>this.evaluateExpression(e))):t}evaluateExpression(t){const e=this.scanner.scan(t),s=this.parser.parse(e);this.parser.errors.length&&this.error(`Template string  error: ${this.parser.errors[0]}`);let r="";for(const t of s)r+=`${this.interpreter.evaluate(t)}`;return r}visitDoctypeKNode(t){}error(t){throw new Error(`Runtime Error => ${t}`)}}function U(t,e,s){const r=(new Q).parse(t);return(new O).transpile(r,e,s)}let V=new class{constructor(){this.entity=void 0,this.changes=1,this.dirty=!1,this.render=()=>{this.changes+=1,this.entity&&("function"==typeof this.entity?.$onChanges&&this.entity.$onChanges(),this.changes>0&&!this.dirty&&(this.dirty=!0,queueMicrotask((()=>{!function(t){if("undefined"==typeof window)return void console.error("kasper requires a browser environment to render templates.");const e=document.getElementsByTagName("template")[0];if(!e)return void console.error("No template found in the document.");const s=document.getElementsByTagName("kasper-app"),r=U(e.innerHTML,t,s[0]);document.body.appendChild(r)}(this.entity),"function"==typeof this.entity?.$onRender&&this.entity.$onRender(),this.dirty=!1,this.changes=0}))))}}};class W{constructor(t){this._value=t}get value(){return this._value}set(t){this._value=t,V.render()}toString(){return this._value.toString()}}"undefined"!=typeof window?((window||{}).kasper={execute:function(t){const e=new Q,s=e.parse(t);return e.errors.length?JSON.stringify(e.errors):JSON.stringify(s)},transpile:U,App:function(t){const e=new Q,s=document.querySelector(t.root||"body"),r=function(t,e){const s={...t};for(const s of Object.keys(t)){const r=t[s];r.template=document.querySelector(r.selector),r.nodes=e.parse(r.template.innerHTML)}return s}(t.registry,e),i=function(t,e,s){const r=document.createElement(e),i=new s[e].component;i.$onInit();const n=s[e].nodes;return t.transpile(n,i,r)}(new O({registry:r}),t.entry||"kasper-app",r);s.appendChild(i)}},window.Kasper=function(t){const e=new t;V.entity=e,V.render(),"function"==typeof e.$onInit&&e.$onInit()},window.Component=class{constructor(t){this.args={},this.$onInit=()=>{},this.$onRender=()=>{},this.$onChanges=()=>{},this.$onDestroy=()=>{},t?(t.args&&(this.args=t.args||{}),t.ref&&(this.ref=t.ref),t.transpiler&&(this.transpiler=t.transpiler)):this.args={}}$doRender(){this.transpiler}},window.$state=function(t){return new W(t)}):"undefined"!=typeof exports&&(exports.kasper={ExpressionParser:P,Interpreter:D,Scanner:L,TemplateParser:Q,Transpiler:O,Viewer:class{constructor(){this.errors=[]}evaluate(t){return t.accept(this)}transpile(t){this.errors=[];const e=[];for(const s of t)try{e.push(this.evaluate(s))}catch(t){if(console.error(`${t}`),this.errors.push(`${t}`),this.errors.length>100)return this.errors.push("Error limit exceeded"),e}return e}visitElementKNode(t){let e=t.attributes.map((t=>this.evaluate(t))).join(" ");if(e.length&&(e=" "+e),t.self)return`<${t.name}${e}/>`;const s=t.children.map((t=>this.evaluate(t))).join("");return`<${t.name}${e}>${s}</${t.name}>`}visitAttributeKNode(t){return t.value?`${t.name}="${t.value}"`:t.name}visitTextKNode(t){return t.value}visitCommentKNode(t){return`\x3c!-- ${t.value} --\x3e`}visitDoctypeKNode(t){return`<!doctype ${t.value}>`}error(t){throw new Error(`Runtime Error => ${t}`)}}})})();